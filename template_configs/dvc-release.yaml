stages:
  export_onnx:
    cmd: poetry run python -m ${moduleName}.scripts.release export-onnx
    deps:
      - src/${moduleName}/scripts/release.py
      - src/${moduleName}/model/model.py
      - models/model.ckpt
      - params.yaml
    outs:
      - releases/model.onnx
      - releases/model_info.json
    params:
      - release

  create_tag:
    cmd: poetry run python -m ${moduleName}.scripts.release create-tag
    deps:
      - src/${moduleName}/scripts/release.py
      - releases/model_info.json
    outs:
      - releases/.git_tag_created
    always_changed: true

  upload_to_s3:
    cmd: poetry run python -m ${moduleName}.scripts.release upload-s3
    deps:
      - src/${moduleName}/scripts/release.py
      - releases/model.onnx
      - releases/model_info.json
      - models/model.ckpt
    outs:
      - releases/.s3_upload_complete
    always_changed: true
