const { python, TextFile, SampleFile } = require('projen');
const fs = require('fs');
const path = require('path');

// --- Paths ---
const TEMPLATE_DIR = path.resolve('ml-aws-template'); // submodule
const TEMPLATE_CONFIGS = path.join(TEMPLATE_DIR, 'template_configs');
const TEMPLATE_SRC = path.join(TEMPLATE_DIR, 'src');

// --- Helpers ---
function readTemplate(filename, replacements = {}, asString = false) {
  const fullPath = path.resolve(filename);
  if (!fs.existsSync(fullPath)) {
    throw new Error(`Template file not found: ${fullPath}`);
  }

  let content = fs.readFileSync(fullPath, 'utf8');
  for (const [key, value] of Object.entries(replacements)) {
    // Replace both {{ key }} and ${key} patterns
    content = content.replace(new RegExp(`{{ ${key} }}`, 'g'), value);
    content = content.replace(new RegExp(`\\$\\{${key}\\}`, 'g'), value);
  }
  return asString ? content : content.split('\n');
}

// --- Project metadata ---
const project = new python.PythonProject({
  authorName: process.env.AUTHOR_NAME || 'My Name',
  authorEmail: process.env.AUTHOR_MAIL || 'my-email@email.com',
  moduleName: process.env.MODULE_NAME || path.basename(process.cwd()).replace("-", "_"),
  name: process.env.PROJECT_NAME || path.basename(process.cwd()),
  version: '0.1.0',

  // Set desired Python range
  python: '>=3.9,<4.0',

  deps: [
    'pytorch-lightning',
    'torch',
    'torchvision',
    'torchmetrics',
    'mlflow',
    'dvc[s3]',
    'boto3',
    'matplotlib',
    'numpy',
    'tqdm',
    'onnx',
    'onnxruntime-gpu',
    'python-dotenv',
    'gitpython',
  ],

  // Don't use poetry - we'll use pip with requirements.txt instead
  // We need venv: true to satisfy projen's requirement for an environment tool
  // But we'll disable automatic installation via postSynthesize hook
  poetry: false,
  pip: true,
  venv: true,

  tasks: {
    'dvc:pull': { exec: 'dvc pull' },
    'dvc:push': { exec: 'dvc push' },
    'dvc:repro': { exec: 'dvc repro' },
  },

  gitignore: ['data/', 'models/', 'notebooks/', 'mlruns/', '.dvc/cache', '*.DS_Store', '.env'],
});

// Disable automatic dependency installation during bootstrap
// Override immediately after project creation, BEFORE synthesis
// Check environment variable to skip installation during bootstrap
if (process.env.SKIP_VENV_INSTALL === '1') {
  // Override venv installDependencies method immediately after project creation
  if (project.venv) {
    const originalInstallDependencies = project.venv.installDependencies;
    if (typeof originalInstallDependencies === 'function') {
      project.venv.installDependencies = function() {
        console.log('⚠️  Skipping automatic dependency installation during bootstrap.');
        console.log('   Install manually later with: pip install -r requirements.txt');
        return Promise.resolve();
      };
    }
  }
  
  // Also override the install task if it exists
  const installTask = project.tasks.tryFind('install');
  if (installTask) {
    project.tasks.removeTask('install');
    project.addTask('install', {
      exec: 'echo "⚠️  Skipping automatic dependency installation. Install manually with: pip install -r requirements.txt"',
      description: 'Install dependencies (disabled during bootstrap)',
    });
  }
}

const moduleName = project.moduleName;

// Note: requirements.txt is automatically generated by projen when pip: true is set
// We don't need to create it manually - projen will handle it

// Generate setup.py for package installation and versioning
// Use regular string (not template literal) so ${} placeholders aren't evaluated prematurely
const authorName = process.env.AUTHOR_NAME || 'My Name';
const authorEmail = process.env.AUTHOR_MAIL || 'my-email@email.com';

const setupPyContent = [
  'from setuptools import setup, find_packages',
  'import os',
  '',
  '# Read long description from README if it exists',
  "long_description = ''",
  "if os.path.exists('README.md'):",
  "    with open('README.md', 'r', encoding='utf-8') as f:",
  '        long_description = f.read()',
  '',
  '# Read requirements from requirements.txt',
  'requirements = []',
  "if os.path.exists('requirements.txt'):",
  "    with open('requirements.txt', 'r', encoding='utf-8') as f:",
  '        requirements = [',
  "            line.strip()",
  '            for line in f',
  "            if line.strip() and not line.strip().startswith('#')",
  '        ]',
  '',
  'setup(',
  `    name='${project.name}',`,
  `    version='${project.version}',`,
  `    description='${project.name} - ML project',`,
  '    long_description=long_description,',
  "    long_description_content_type='text/markdown',",
  `    author='${authorName}',`,
  `    author_email='${authorEmail}',`,
  '    packages=find_packages(where=\'src\'),',
  "    package_dir={'': 'src'},",
  "    python_requires='>=3.9,<4.0',",
  '    install_requires=requirements,',
  '    classifiers=[',
  "        'Development Status :: 3 - Alpha',",
  "        'Intended Audience :: Developers',",
  "        'Programming Language :: Python :: 3',",
  "        'Programming Language :: Python :: 3.9',",
  "        'Programming Language :: Python :: 3.10',",
  "        'Programming Language :: Python :: 3.11',",
  '    ],',
  ')',
];

new TextFile(project, 'setup.py', { lines: setupPyContent });

// --- Config files ---
try {
  new TextFile(project, 'dvc.yaml', { lines: readTemplate(path.join(TEMPLATE_CONFIGS, 'dvc.yaml'), { moduleName }) });
  new TextFile(project, 'params.yaml', { lines: readTemplate(path.join(TEMPLATE_CONFIGS, 'params.yaml')) });
  new TextFile(project, '.env.example', { lines: readTemplate(path.join(TEMPLATE_CONFIGS, 'environment.env')) });

  new TextFile(project, '.circleci/config.yml', {
    lines: readTemplate(
      path.join(TEMPLATE_CONFIGS, 'circleci_config.yaml'),
      { projectName: project.name, moduleName }
    ),
  });

  new TextFile(project, 'Dockerfile', { lines: readTemplate(path.join(TEMPLATE_CONFIGS, 'Dockerfile'), { moduleName }) });
} catch (error) {
  console.error('Error creating config files:', error.message);
  console.error('Template path:', TEMPLATE_CONFIGS);
  throw error;
}

// --- Python source scaffolding ---
function safeSampleFile(relPath, templateRelPath) {
  const fullTemplatePath = path.join(TEMPLATE_SRC, templateRelPath);
  let contents = '# Placeholder\n';
  if (fs.existsSync(fullTemplatePath)) {
    contents = readTemplate(fullTemplatePath, { moduleName }, true);
  }
  return new SampleFile(project, relPath, { contents });
}

// Base modules
safeSampleFile(`src/${moduleName}/__init__.py`, '__init__.py');
safeSampleFile(`src/${moduleName}/data/__init__.py`, 'data/__init__.py');
safeSampleFile(`src/${moduleName}/model/__init__.py`, 'model/__init__.py');

// Core ML files
safeSampleFile(`src/${moduleName}/model/model.py`, 'model/model.py');
safeSampleFile(`src/${moduleName}/data/datamodule.py`, 'data/datamodule.py');
safeSampleFile(`src/${moduleName}/register_model.py`, 'register_model.py');
safeSampleFile(`src/${moduleName}/data/preprocess.py`, 'data/preprocess.py');
safeSampleFile(`src/${moduleName}/train.py`, 'train.py');
safeSampleFile(`src/${moduleName}/export_and_benchmark.py`, 'export_and_benchmark.py');

// Simple test placeholder
new SampleFile(project, `tests/test_basic.py`, {
  contents: `def test_import():\n    import ${moduleName}\n    assert 1 == 1\n`,
});

// --- Synthesize project ---
// When running via `npx projen`, synthesis is automatic
// But if running directly with `node .projenrc.js`, we need to call it
if (require.main === module) {
  project.synth();
}
